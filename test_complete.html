<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MATRIX - Full Sequential Mapping Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="header">
    <h1>MATRIX - Complete Sequential Mapping Test</h1>
  </div>
  <div class="container">
    <nav class="tabs" role="tablist">
      <button data-tab="main" class="active">Weekly Cashflow</button>
      <button data-tab="pnl">Profit & Loss</button>
      <button data-tab="roi">Investment Return & Repayments</button>
    </nav>
    
    <section id="main" class="tab-content active">
      <h2>Weekly Cashflow</h2>
      <!-- Sequential Column Mapping Banner -->
      <div class="mapping-summary-banner">
        <div style="background: #e3f2fd; padding: 10px 12px; border-radius: 4px; margin-bottom: 12px; border-left: 3px solid #1976d2; font-size: 0.9em;">
          <strong>üìã Sequential Column Mapping:</strong> 
          7 columns mapped as Week 1, Week 2, Week 3, etc. | 
          Column range: 3-9 Jan to 14-20 Feb |
          <span style="color: #4caf50;">‚úÖ All calculations use column-based sequential mapping</span>
        </div>
      </div>
      
      <div class="subtabs" role="tablist">
        <button data-subtab="mapping" class="active">Spreadsheet Mapping</button>
        <button data-subtab="charts">Weekly Cashflow Charts & Analysis</button>
      </div>
      
      <div id="subtab-mapping" class="subtab-panel active">
        <h3>Spreadsheet Mapping</h3>
        <div id="mappingPanel">
          <!-- Populated by simplified mapping logic -->
        </div>
      </div>
      
      <div id="subtab-charts" class="subtab-panel">
        <h3>Weekly Cashflow Charts & Analysis</h3>
        <div class="info-banner" style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #1976d2;">
          <strong>‚ÑπÔ∏è Direct Spreadsheet Column Mapping:</strong> This view shows cashflow and bank balance for each week exactly as mapped from your uploaded spreadsheet columns in sequential order.
          <div style="margin-top: 8px; font-size: 0.9em; color: #1565c0;">
            <strong>Tip:</strong> Week numbers shown here correspond to spreadsheet columns (Week 1 = 1st column, Week 2 = 2nd column, etc.). Use the Spreadsheet Mapping tab to configure which columns represent your weekly data.
          </div>
        </div>
        <div id="weeklyData">
          <!-- Will show weekly cashflow data -->
        </div>
      </div>
    </section>
    
    <section id="pnl" class="tab-content">
      <h2>Profit & Loss Statement</h2>
      <!-- Sequential Column Mapping Banner -->
      <div class="mapping-summary-banner">
        <div style="background: #e3f2fd; padding: 10px 12px; border-radius: 4px; margin-bottom: 12px; border-left: 3px solid #1976d2; font-size: 0.9em;">
          <strong>üìã Sequential Column Mapping:</strong> 
          7 columns mapped as Week 1, Week 2, Week 3, etc. | 
          Column range: 3-9 Jan to 14-20 Feb |
          <span style="color: #4caf50;">‚úÖ All calculations use column-based sequential mapping</span>
        </div>
      </div>
      
      <div class="info-banner" style="background: #e8f5e8; padding: 12px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #4caf50;">
        <strong>üìä Direct Profitability Analysis:</strong> Shows profitability per week using sequential column mapping from your spreadsheet (Week 1, Week 2, etc.).
        <div style="margin-top: 8px; font-size: 0.9em; color: #2e7d32;">
          <strong>Tip:</strong> Week numbers here correspond exactly to your Weekly Cashflow tab for easy cross-referencing.
        </div>
      </div>
      
      <div id="pnlSummary">
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 16px;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="border: 1px solid #ddd; padding: 8px;">Week</th>
              <th style="border: 1px solid #ddd; padding: 8px;">Income</th>
              <th style="border: 1px solid #ddd; padding: 8px;">Expenses</th>
              <th style="border: 1px solid #ddd; padding: 8px;">Net Profit</th>
              <th style="border: 1px solid #ddd; padding: 8px;">Bank Balance</th>
            </tr>
          </thead>
          <tbody id="pnlTableBody">
            <!-- Will be populated with data -->
          </tbody>
        </table>
      </div>
    </section>
    
    <section id="roi" class="tab-content">
      <h2>Investment Return & Repayments</h2>
      <!-- Sequential Column Mapping Banner -->
      <div class="mapping-summary-banner">
        <div style="background: #e3f2fd; padding: 10px 12px; border-radius: 4px; margin-bottom: 12px; border-left: 3px solid #1976d2; font-size: 0.9em;">
          <strong>üìã Sequential Column Mapping:</strong> 
          7 columns mapped as Week 1, Week 2, Week 3, etc. | 
          Column range: 3-9 Jan to 14-20 Feb |
          <span style="color: #4caf50;">‚úÖ All calculations use column-based sequential mapping</span>
        </div>
      </div>
      
      <!-- Spreadsheet Column Mapping Preview -->
      <div class="spreadsheet-date-preview" style="background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:1em; border-left:4px solid #007bff;">
        <h4 style="margin:0 0 10px 0; color:#007bff;">üìã Spreadsheet Column Mapping</h4>
        <div style="font-size:0.9em; color:#6c757d; margin-bottom:8px;">
          Columns are mapped sequentially as Week 1, Week 2, etc. based on spreadsheet column order. All calculations use this consistent column-based mapping.
        </div>
        <div id="spreadsheetDateMappingSummary" style="font-size:0.95em; padding:6px 0;">
          <span id="dateMappingStatus">7 columns mapped sequentially as Week 1, Week 2, etc. ‚úì</span>
        </div>
      </div>
      
      <div id="roiCalculations">
        <h4>Sequential Week Mapping for ROI Calculations</h4>
        <p>Week 1: 3-9 Jan ‚Üí Income: ‚Ç¨1,000, Expenses: ‚Ç¨800, Net: ‚Ç¨200</p>
        <p>Week 2: 10-16 Jan ‚Üí Income: ‚Ç¨1,200, Expenses: ‚Ç¨900, Net: ‚Ç¨300</p>
        <p>Week 3: 17-23 Jan ‚Üí Income: ‚Ç¨1,100, Expenses: ‚Ç¨850, Net: ‚Ç¨250</p>
        <p>Week 4: 24-30 Jan ‚Üí Income: ‚Ç¨1,300, Expenses: ‚Ç¨950, Net: ‚Ç¨350</p>
        <p>Week 5: 31 Jan-6 Feb ‚Üí Income: ‚Ç¨1,400, Expenses: ‚Ç¨1,000, Net: ‚Ç¨400</p>
        <p>Week 6: 7-13 Feb ‚Üí Income: ‚Ç¨1,500, Expenses: ‚Ç¨1,100, Net: ‚Ç¨400</p>
        <p>Week 7: 14-20 Feb ‚Üí Income: ‚Ç¨1,600, Expenses: ‚Ç¨1,200, Net: ‚Ç¨400</p>
        
        <div style="background: #e8f5e8; padding: 12px; border-radius: 6px; margin-top: 16px; border-left: 4px solid #4caf50;">
          <strong>‚úÖ Sequential Mapping Success:</strong> All 7 weeks mapped successfully without date parsing errors. 
          Total Income: ‚Ç¨9,100 | Total Expenses: ‚Ç¨6,800 | Total Net: ‚Ç¨2,300
        </div>
      </div>
    </section>
  </div>
  
  <script>
    // Simulate the complete MATRIX application with sequential mapping
    let rawData = [
      ['Category', '3-9 Jan', '10-16 Jan', '17-23 Jan', '24-30 Jan', '31 Jan-6 Feb', '7-13 Feb', '14-20 Feb'],
      ['Income', 1000, 1200, 1100, 1300, 1400, 1500, 1600],
      ['Expenses', 800, 900, 850, 950, 1000, 1100, 1200],
      ['Bank Balance', 200, 500, 750, 1100, 1500, 1900, 2300]
    ];
    
    let mappedData = rawData;
    let config = {
      weekLabelRow: 0,
      weekColStart: 1,
      weekColEnd: 7,
      firstDataRow: 1,
      lastDataRow: 3
    };
    let weekLabels = [];
    let openingBalance = 0;
    let userSpecifiedBaseYear = null;
    
    // Tab switching functionality
    function setupTabs() {
      document.querySelectorAll('.tabs button').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(sec => sec.classList.remove('active'));
          var tabId = btn.getAttribute('data-tab');
          var panel = document.getElementById(tabId);
          if (panel) panel.classList.add('active');
        });
      });
      
      document.querySelectorAll('.subtabs button').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.subtabs button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.subtab-panel').forEach(sec => sec.classList.remove('active'));
          var subtabId = 'subtab-' + btn.getAttribute('data-subtab');
          var subpanel = document.getElementById(subtabId);
          if (subpanel) subpanel.classList.add('active');
        });
      });
    }
    
    function renderSimplifiedMappingPanel() {
      const panel = document.getElementById('mappingPanel');
      if (!panel) return;
      
      // Extract week labels
      let weekRow = mappedData[config.weekLabelRow] || [];
      weekLabels = weekRow.slice(config.weekColStart, config.weekColEnd+1).map(x => x || '');
      
      panel.innerHTML = `
        <!-- Step 1: Simplified mapping summary -->
        <div style="background: #e8f5e8; padding: 12px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #4caf50;">
          <h4 style="margin: 0 0 8px 0; color: #2e7d32;">‚úÖ Week Columns Mapped in Order as per Spreadsheet</h4>
          <div style="font-size: 0.9em; margin-bottom: 6px;">
            <strong>Sequential Mapping:</strong> ${weekLabels.length} columns mapped as Week 1, Week 2, Week 3, etc. |
            <strong>Data Rows:</strong> ${config.firstDataRow + 1} to ${config.lastDataRow + 1}
          </div>
          <div style="font-size: 0.85em; color: #2e7d32;">
            Each spreadsheet column is treated as a sequential week regardless of column labels. All downstream calculations use this column-based mapping.
          </div>
        </div>
        
        <!-- Step 2: Essential inputs -->
        <div style="margin-bottom: 16px;">
          <div style="margin-bottom: 12px;">
            <label for="openingBalanceInput" style="font-weight: bold; margin-right: 8px;">Opening Balance:</label>
            <input type="number" id="openingBalanceInput" value="0" 
                   style="width:120px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;" 
                   placeholder="0">
            <span style="margin-left: 8px; font-size: 0.9em; color: #666;">Starting bank balance</span>
          </div>
          
          <div style="margin-bottom: 12px;">
            <label for="baseYearInput" style="font-weight: bold; margin-right: 8px;">First Week Date (Optional):</label>
            <input type="number" id="baseYearInput" value="2024" min="2023" max="2100" 
                   style="width:100px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;" 
                   placeholder="e.g. 2023">
            <span id="currentYearDisplay" style="margin-left: 12px; font-size: 0.9em; color: #666;">
              Weeks will start from Jan 1, 2024 and increment by 7 days
            </span>
            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
              Leave blank to use current date. This only affects date calculations - column mapping remains sequential.
            </div>
          </div>
        </div>
        
        <!-- Step 3: Column mapping preview -->
        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #6c757d;">
          <h5 style="margin: 0 0 8px 0; color: #495057;">üìã Column Mapping Preview</h5>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 0.9em;">
            ${weekLabels.map((label, index) => 
              `<div style="padding: 4px 8px; background: white; border-radius: 4px; border: 1px solid #dee2e6;">
                <strong>Week ${index + 1}:</strong> ${label}
              </div>`
            ).join('')}
          </div>
        </div>
        
        <!-- Step 4: Advanced options (collapsed by default) -->
        <div style="margin-top: 20px; border-top: 1px solid #e0e0e0; padding-top: 16px;">
          <button type="button" id="advancedBtn" style="background: none; border: none; color: #6c757d; font-weight: bold; cursor: pointer; font-size: 0.9em; padding: 8px 0;">
            <span class="caret" style="margin-right: 6px;">‚ñ∂</span>Advanced Mapping Options
          </button>
          <div id="advancedContent" style="display: none; margin-top: 12px; padding: 16px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
            <p>Advanced options would include:</p>
            <ul>
              <li>Manual row/column selection</li>
              <li>Week column filters</li>
              <li>Data validation settings</li>
              <li>Custom week label overrides</li>
            </ul>
          </div>
        </div>
      `;
      
      // Setup advanced toggle
      const advancedBtn = document.getElementById('advancedBtn');
      const advancedContent = document.getElementById('advancedContent');
      if (advancedBtn && advancedContent) {
        advancedBtn.addEventListener('click', function() {
          const isOpen = advancedContent.style.display !== 'none';
          advancedContent.style.display = isOpen ? 'none' : 'block';
          const caret = advancedBtn.querySelector('.caret');
          if (caret) {
            caret.textContent = isOpen ? '‚ñ∂' : '‚ñº';
          }
          advancedBtn.innerHTML = `<span class="caret" style="margin-right: 6px;">${isOpen ? '‚ñ∂' : '‚ñº'}</span>${isOpen ? 'Advanced Mapping Options' : 'Hide Advanced Options'}`;
        });
      }
    }
    
    function renderWeeklyData() {
      const container = document.getElementById('weeklyData');
      if (!container) return;
      
      let html = '<h4>Sequential Week Data</h4><table style="width: 100%; border-collapse: collapse;">';
      html += '<thead><tr style="background: #f5f5f5;">';
      html += '<th style="border: 1px solid #ddd; padding: 8px;">Week</th>';
      html += '<th style="border: 1px solid #ddd; padding: 8px;">Column Label</th>';
      html += '<th style="border: 1px solid #ddd; padding: 8px;">Income</th>';
      html += '<th style="border: 1px solid #ddd; padding: 8px;">Expenses</th>';
      html += '<th style="border: 1px solid #ddd; padding: 8px;">Net</th>';
      html += '</tr></thead><tbody>';
      
      for (let i = 0; i < weekLabels.length; i++) {
        const income = rawData[1][i + 1] || 0;
        const expenses = rawData[2][i + 1] || 0;
        const net = income - expenses;
        
        html += `<tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Week ${i + 1}</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${weekLabels[i]}</td>
          <td style="border: 1px solid #ddd; padding: 8px;">‚Ç¨${income.toLocaleString()}</td>
          <td style="border: 1px solid #ddd; padding: 8px;">‚Ç¨${expenses.toLocaleString()}</td>
          <td style="border: 1px solid #ddd; padding: 8px; color: ${net >= 0 ? '#4caf50' : '#f44336'};">‚Ç¨${net.toLocaleString()}</td>
        </tr>`;
      }
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    function renderPnlData() {
      const tbody = document.getElementById('pnlTableBody');
      if (!tbody) return;
      
      let html = '';
      let runningBalance = 0;
      
      for (let i = 0; i < weekLabels.length; i++) {
        const income = rawData[1][i + 1] || 0;
        const expenses = rawData[2][i + 1] || 0;
        const net = income - expenses;
        runningBalance += net;
        
        html += `<tr>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Week ${i + 1}</td>
          <td style="border: 1px solid #ddd; padding: 8px;">‚Ç¨${income.toLocaleString()}</td>
          <td style="border: 1px solid #ddd; padding: 8px;">‚Ç¨${expenses.toLocaleString()}</td>
          <td style="border: 1px solid #ddd; padding: 8px; color: ${net >= 0 ? '#4caf50' : '#f44336'};">‚Ç¨${net.toLocaleString()}</td>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">‚Ç¨${runningBalance.toLocaleString()}</td>
        </tr>`;
      }
      
      tbody.innerHTML = html;
    }
    
    // Initialize everything
    document.addEventListener('DOMContentLoaded', function() {
      setupTabs();
      renderSimplifiedMappingPanel();
      renderWeeklyData();
      renderPnlData();
    });
  </script>
</body>
</html>